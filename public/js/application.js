var app=angular.module("dxLog",["ngResource","angucomplete-alt","ui.router","satellizer","ngFileUpload","ngMap","ngDialog"]);app.config(["$stateProvider","$urlRouterProvider","$locationProvider","$authProvider",function(t,e,r,o){function a(t,e){e.isAuthenticated()&&t.path("/")}function n(t,e){e.isAuthenticated()||t.path("/login")}n.$inject=["$location","$auth"],a.$inject=["$location","$auth"],t.state("index",{url:"/",templateUrl:"partials/main.html",controller:"MainCtrl"}).state("station",{url:"/station/:station",templateUrl:"partials/main.html",controller:"MainCtrl"}).state("country",{url:"/country/:itu",templateUrl:"partials/main.html",controller:"MainCtrl"}).state("transmitter",{url:"/transmitter/:site",templateUrl:"partials/main.html",controller:"MainCtrl"}).state("addlog",{url:"/addlog",templateUrl:"partials/addlog.html",controller:"NewLogForm",resolve:{loginRequired:n}}).state("stats",{url:"/stats",templateUrl:"partials/stats.html",controller:"FreqStats"}).state("login",{url:"/login",templateUrl:"partials/login.html",controller:"LoginCtrl",resolve:{skipIfAuthenticated:a}}).state("signup",{url:"/signup",templateUrl:"partials/signup.html",controller:"SignupCtrl",resolve:{skipIfAuthenticated:a}}).state("account",{url:"/account",templateUrl:"partials/profile.html",controller:"ProfileCtrl",resolve:{loginRequired:n}}).state("forgot",{url:"/forgot",templateUrl:"partials/forgot.html",controller:"ForgotCtrl",resolve:{skipIfAuthenticated:a}}).state("reset",{url:"/reset/:token",templateUrl:"partials/reset.html",controller:"ResetCtrl",resolve:{skipIfAuthenticated:a}}).state("404",{template:"<div>Page not found</div>"}),e.otherwise(function(t,e){var r=t.get("$state");return r.go("404"),e.path()}),r.html5Mode(!0),o.loginUrl="/login",o.signupUrl="/signup"}]).run(["$rootScope","$window",function(t,e){e.localStorage.user&&(t.currentUser=JSON.parse(e.localStorage.user))}]),app.factory("StationsService",["$resource",function(t){var e="http://localhost:3000/api/",r={};return{query:function(r,o){return t(e+r).query(function(){})},messages:r,post:function(o){t(e+"logs").save(o,function(t,e){r.success="Item has been added successfully"},function(t){r.error="Error occured"})}}}]),app.service("ColorService",function(){this.set=function(t,e){angular.forEach(t,function(r,o){e.findIndex(function(e){return e.freq===t[o].freq})==-1&&e.push({freq:t[o].freq})}),angular.forEach(e,function(t,r){r%2==0?e[r].even=!1:e[r].even=!0})},this.filter=function(t,e,r){if("freq"==t)return e[e.findIndex(function(t){return t.freq===r})].even}}),app.filter("unique",function(){return function(t,e){var r=[],o=[];return angular.forEach(t,function(t,e){var a=t.location._id;o.indexOf(a)===-1&&(o.push(a),r.push(t.location))}),r}}),app.controller("MainCtrl",["$scope","$http","$filter","$state","$stateParams","$resource","StationsService","ColorService","$sce","NgMap",function(t,e,r,o,a,n,s,i,u,c){switch(t.col="freq",t.reverse=!1,t.ituFilter={},t.setFilter=function(e){t.ituFilter.itu=e},t.freqs=[],t.rx=[49.34,19.84],t.state=o,t.url=function(){switch(o.current.name){case"index":return"logs";case"station":return"network/"+a.station;case"country":return"itu/"+a.itu;case"transmitter":return"location/"+a.site}},t.stations=s.query(t.url()),t.stations.$promise.then(function(){switch(t.total=t.stations.length,i.set(t.stations,t.freqs),o.current.name){case"country":var e=t.stations[0].location;t.itu=e.itu,t.title=e.country+" ("+e.itu+")",t.transmitters=r("unique")(t.stations,"location._id");break;case"station":t.title=t.stations[0].station,t.transmitters=t.stations;break;case"transmitter":var e=t.stations[0].location;t.transmitter=e,t.title=e.site+", "+e.country+" ("+e.qrb+"km)"}}),o.current.name){case"index":t.itus=s.query("stats/itu")}t.mapClick=function(t,e){o.go("transmitter",{site:e._id})},t.color=function(t,e,r){return i.filter(t,e,r)},t.order=function(e){t.reverse=(t.col===e||t.col[0]===e[0])&&!t.reverse,t.col=e},t.playAudio=function(e){t.audio=e,t.audioUrl=u.trustAsResourceUrl("audio/"+e)}}]),app.controller("FreqStats",["$scope","StationsService",function(t,e){t.freqs=e.query("stats/freq"),t.max=0,t.freqs.$promise.then(function(){t.max=Math.max.apply(Math,t.freqs.map(function(t){return t.count}))})}]),app.controller("NewLogForm",["$scope","StationsService","Upload","$timeout",function(t,e,r,o){delete e.messages.success,delete e.messages.error,t.formData={},t.formData.location={},t.formData.pol="h",t.formData.firstLog=new Date,t.messages=e.messages,t.stations=[],t.sites=[],t.selectedStation=function(e){t.formData.station=e.title||e.originalObject},t.selectedTransmitter=function(e){var r=t.formData.location,o=e.originalObject;r.site=e.title||o,e.title&&(r.country=o.country,r.itu=o.itu,r.long=o.long,r.lat=o.lat,r.qrb=o.qrb)},t.autocomplet=e.query("autocomplete"),t.autocomplet.$promise.then(function(){t.stations=t.autocomplet[0].stations,t.sites=t.autocomplet[0].transmitters}),t.upload=function(e){e.upload=r.upload({url:"api/upload",data:{file:e}}),e.upload.then(function(t){o(function(){e.result=t.data})},function(e){e.status>0&&(t.errorMsg=e.status+": "+e.data)},function(t){e.progress=Math.min(100,parseInt(100*t.loaded/t.total))})},t.log=function(){console.log(t.formData),console.log(t.file)},t.sendForm=function(){t.file&&(t.upload(t.file),t.formData.audio=t.file.name),e.post(t.formData),delete e.messages.success,delete e.messages.error},t.parseCSV=function(){}}]),angular.module("dxLog").controller("ForgotCtrl",["$scope","Account",function(t,e){t.forgotPassword=function(){e.forgotPassword(t.user).then(function(e){t.messages={success:[e.data]}}).catch(function(e){t.messages={error:Array.isArray(e.data)?e.data:[e.data]}})}}]),angular.module("dxLog").controller("HeaderCtrl",["$scope","$location","$window","$auth","ngDialog",function(t,e,r,o,a){t.isActive=function(t){return t===e.path()},t.isAuthenticated=function(){return o.isAuthenticated()},t.addLog=function(){a.open({template:"partials/addlog.html",controller:"NewLogForm",closeByNavigation:!0,className:"ngdialog-theme-plain"})},t.logout=function(){o.logout(),delete r.localStorage.user,e.path("/")}}]),angular.module("dxLog").controller("LoginCtrl",["$scope","$rootScope","$location","$window","$auth",function(t,e,r,o,a){t.login=function(){a.login(t.user).then(function(t){e.currentUser=t.data.user,o.localStorage.user=JSON.stringify(t.data.user),r.path("/account")}).catch(function(e){t.messages={error:Array.isArray(e.data)?e.data:[e.data]}})},t.authenticate=function(n){a.authenticate(n).then(function(t){e.currentUser=t.data.user,o.localStorage.user=JSON.stringify(t.data.user),r.path("/")}).catch(function(e){e.error?t.messages={error:[{msg:e.error}]}:e.data&&(t.messages={error:[e.data]})})}}]),angular.module("dxLog").controller("ProfileCtrl",["$scope","$rootScope","$location","$window","$auth","Account",function(t,e,r,o,a,n){t.profile=e.currentUser,t.updateProfile=function(){n.updateProfile(t.profile).then(function(r){e.currentUser=r.data.user,o.localStorage.user=JSON.stringify(r.data.user),t.messages={success:[r.data]}}).catch(function(e){t.messages={error:Array.isArray(e.data)?e.data:[e.data]}})},t.changePassword=function(){n.changePassword(t.profile).then(function(e){t.messages={success:[e.data]}}).catch(function(e){t.messages={error:Array.isArray(e.data)?e.data:[e.data]}})},t.link=function(e){a.link(e).then(function(e){t.messages={success:[e.data]}}).catch(function(e){o.scrollTo(0,0),t.messages={error:[e.data]}})},t.unlink=function(e){a.unlink(e).then(function(){t.messages={success:[response.data]}}).catch(function(e){t.messages={error:[e.data]}})},t.deleteAccount=function(){n.deleteAccount().then(function(){a.logout(),delete o.localStorage.user,r.path("/")}).catch(function(e){t.messages={error:[e.data]}})}}]),angular.module("dxLog").controller("ResetCtrl",["$scope","Account",function(t,e){t.resetPassword=function(){e.resetPassword(t.user).then(function(e){t.messages={success:[e.data]}}).catch(function(e){t.messages={error:Array.isArray(e.data)?e.data:[e.data]}})}}]),angular.module("dxLog").controller("SignupCtrl",["$scope","$rootScope","$location","$window","$auth",function(t,e,r,o,a){t.signup=function(){a.signup(t.user).then(function(t){a.setToken(t),e.currentUser=t.data.user,o.localStorage.user=JSON.stringify(t.data.user),r.path("/")}).catch(function(e){t.messages={error:Array.isArray(e.data)?e.data:[e.data]}})},t.authenticate=function(n){a.authenticate(n).then(function(t){e.currentUser=t.data.user,o.localStorage.user=JSON.stringify(t.data.user),r.path("/")}).catch(function(e){e.error?t.messages={error:[{msg:e.error}]}:e.data&&(t.messages={error:[e.data]})})}}]),angular.module("dxLog").factory("Account",["$http",function(t){return{updateProfile:function(e){return t.put("/account",e)},changePassword:function(e){return t.put("/account",e)},deleteAccount:function(){return t.delete("/account")},forgotPassword:function(e){return t.post("/forgot",e)},resetPassword:function(e){return t.post("/reset",e)}}}]);